{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport { mergeOptions } from \"../../core/index.js\";\nimport { equal } from '@wry/equality';\nimport { DocumentType, verifyDocumentType } from \"../parser/index.js\";\nimport { ApolloError } from \"../../errors/index.js\";\nimport { useApolloClient } from \"./useApolloClient.js\";\nexport function useMutation(mutation, options) {\n  var client = useApolloClient(options === null || options === void 0 ? void 0 : options.client);\n  verifyDocumentType(mutation, DocumentType.Mutation);\n  var _a = useState({\n      called: false,\n      loading: false,\n      client: client\n    }),\n    result = _a[0],\n    setResult = _a[1];\n  var ref = useRef({\n    result: result,\n    mutationId: 0,\n    isMounted: true,\n    client: client,\n    mutation: mutation,\n    options: options\n  });\n  {\n    Object.assign(ref.current, {\n      client: client,\n      options: options,\n      mutation: mutation\n    });\n  }\n  var execute = useCallback(function (executeOptions) {\n    if (executeOptions === void 0) {\n      executeOptions = {};\n    }\n    var _a = ref.current,\n      options = _a.options,\n      mutation = _a.mutation;\n    var baseOptions = __assign(__assign({}, options), {\n      mutation: mutation\n    });\n    var client = executeOptions.client || ref.current.client;\n    if (!ref.current.result.loading && !baseOptions.ignoreResults && ref.current.isMounted) {\n      setResult(ref.current.result = {\n        loading: true,\n        error: void 0,\n        data: void 0,\n        called: true,\n        client: client\n      });\n    }\n    var mutationId = ++ref.current.mutationId;\n    var clientOptions = mergeOptions(baseOptions, executeOptions);\n    return client.mutate(clientOptions).then(function (response) {\n      var _a;\n      var data = response.data,\n        errors = response.errors;\n      var error = errors && errors.length > 0 ? new ApolloError({\n        graphQLErrors: errors\n      }) : void 0;\n      if (mutationId === ref.current.mutationId && !clientOptions.ignoreResults) {\n        var result_1 = {\n          called: true,\n          loading: false,\n          data: data,\n          error: error,\n          client: client\n        };\n        if (ref.current.isMounted && !equal(ref.current.result, result_1)) {\n          setResult(ref.current.result = result_1);\n        }\n      }\n      var onCompleted = executeOptions.onCompleted || ((_a = ref.current.options) === null || _a === void 0 ? void 0 : _a.onCompleted);\n      onCompleted === null || onCompleted === void 0 ? void 0 : onCompleted(response.data, clientOptions);\n      return response;\n    }).catch(function (error) {\n      var _a;\n      if (mutationId === ref.current.mutationId && ref.current.isMounted) {\n        var result_2 = {\n          loading: false,\n          error: error,\n          data: void 0,\n          called: true,\n          client: client\n        };\n        if (!equal(ref.current.result, result_2)) {\n          setResult(ref.current.result = result_2);\n        }\n      }\n      var onError = executeOptions.onError || ((_a = ref.current.options) === null || _a === void 0 ? void 0 : _a.onError);\n      if (onError) {\n        onError(error, clientOptions);\n        return {\n          data: void 0,\n          errors: error\n        };\n      }\n      throw error;\n    });\n  }, []);\n  var reset = useCallback(function () {\n    if (ref.current.isMounted) {\n      setResult({\n        called: false,\n        loading: false,\n        client: client\n      });\n    }\n  }, []);\n  useEffect(function () {\n    ref.current.isMounted = true;\n    return function () {\n      ref.current.isMounted = false;\n    };\n  }, []);\n  return [execute, __assign({\n    reset: reset\n  }, result)];\n}","map":{"version":3,"sources":["../../../src/react/hooks/useMutation.ts"],"names":[],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useRef, useState } from 'react';\nimport { DocumentNode } from 'graphql';\nimport { TypedDocumentNode } from '@graphql-typed-document-node/core';\nimport {\n  MutationFunctionOptions,\n  MutationHookOptions,\n  MutationResult,\n  MutationTuple,\n} from '../types/types';\n\nimport {\n  ApolloCache,\n  DefaultContext,\n  mergeOptions,\n  OperationVariables,\n} from '../../core';\nimport { equal } from '@wry/equality';\nimport { DocumentType, verifyDocumentType } from '../parser';\nimport { ApolloError } from '../../errors';\nimport { useApolloClient } from './useApolloClient';\n\nexport function useMutation<\n  TData = any,\n  TVariables = OperationVariables,\n  TContext = DefaultContext,\n  TCache extends ApolloCache<any> = ApolloCache<any>,\n>(\n  mutation: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: MutationHookOptions<TData, TVariables, TContext, TCache>,\n): MutationTuple<TData, TVariables, TContext, TCache> {\n  const client = useApolloClient(options?.client);\n  verifyDocumentType(mutation, DocumentType.Mutation);\n  const [result, setResult] = useState<Omit<MutationResult, 'reset'>>({\n    called: false,\n    loading: false,\n    client,\n  });\n\n  const ref = useRef({\n    result,\n    mutationId: 0,\n    isMounted: true,\n    client,\n    mutation,\n    options,\n  });\n\n  // TODO: Trying to assign these in a useEffect or useLayoutEffect breaks\n  // higher-order components.\n  {\n    Object.assign(ref.current, { client, options, mutation });\n  }\n\n  const execute = useCallback((\n    executeOptions: MutationFunctionOptions<\n      TData,\n      TVariables,\n      TContext,\n      TCache\n    > = {}\n  ) => {\n    const {options, mutation} = ref.current;\n    const baseOptions = { ...options, mutation };\n    const client = executeOptions.client || ref.current.client;\n\n    if (!ref.current.result.loading && !baseOptions.ignoreResults && ref.current.isMounted) {\n      setResult(ref.current.result = {\n        loading: true,\n        error: void 0,\n        data: void 0,\n        called: true,\n        client,\n      });\n    }\n\n    const mutationId = ++ref.current.mutationId;\n    const clientOptions = mergeOptions(\n      baseOptions,\n      executeOptions as any,\n    );\n\n    return client.mutate(clientOptions).then((response) => {\n      const { data, errors } = response;\n      const error =\n        errors && errors.length > 0\n          ? new ApolloError({ graphQLErrors: errors })\n          : void 0;\n\n      if (\n        mutationId === ref.current.mutationId &&\n        !clientOptions.ignoreResults\n      ) {\n        const result = {\n          called: true,\n          loading: false,\n          data,\n          error,\n          client,\n        };\n\n        if (ref.current.isMounted && !equal(ref.current.result, result)) {\n          setResult(ref.current.result = result);\n        }\n      }\n\n      const onCompleted = executeOptions.onCompleted || ref.current.options?.onCompleted\n      onCompleted?.(response.data!, clientOptions);\n\n      return response;\n    }).catch((error) => {\n      if (\n        mutationId === ref.current.mutationId &&\n        ref.current.isMounted\n      ) {\n        const result = {\n          loading: false,\n          error,\n          data: void 0,\n          called: true,\n          client,\n        };\n\n        if (!equal(ref.current.result, result)) {\n          setResult(ref.current.result = result);\n        }\n      }\n\n      const onError = executeOptions.onError || ref.current.options?.onError\n\n      if (onError) {\n        onError(error, clientOptions);\n\n        // TODO(brian): why are we returning this here???\n        return { data: void 0, errors: error };\n      }\n\n      throw error;\n    });\n  }, []);\n\n  const reset = useCallback(() => {\n    if (ref.current.isMounted) {\n      setResult({ called: false, loading: false, client });\n    }\n  }, []);\n\n  useEffect(() => {\n    ref.current.isMounted = true;\n\n    return () => {\n      ref.current.isMounted = false;\n    };\n  }, []);\n\n  return [execute, { reset, ...result }];\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}